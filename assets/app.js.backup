// A Damn Fine Bridal Party - Main Application Logic

// Firebase Integration Flag
// Set this to true to enable Firebase backend, false to use localStorage only
const FIREBASE_ENABLED = true;

// Firebase Manager (will be initialized if enabled)
let FirebaseManager = null;

// Global data store
const AppData = {
  guests: [],
  characters: [],
  decor: {},
  vendors: [],
  menu: {},
  schedule: {},
  story: {},
  clues: [],
  packets: [],
  // In-memory state for interactive features
  decorFavorites: new Set(),
  decorShoppingList: new Set(),
  menuFavorites: new Set(),
  menuFeatured: new Set(),
  rolePreferences: {}, // guestId -> characterId mapping
  currentPhase: 'intro', // Track current mystery phase
  // Autosave settings
  autosaveEnabled: false,
  // Original defaults for reset
  defaults: {},
  // Firebase sync enabled
  firebaseSyncEnabled: FIREBASE_ENABLED
};

// Initialize Firebase if enabled
async function initFirebase() {
  if (!FIREBASE_ENABLED) return null;
  
  try {
    const module = await import('./firebase-config.js');
    FirebaseManager = module.default;
    await FirebaseManager.init();
    console.log('Firebase initialized successfully');
    return FirebaseManager;
  } catch (error) {
    console.error('Firebase initialization failed:', error);
    return null;
  }
}

// Load all data on page initialization
async function loadData() {
  try {
    // Initialize Firebase if enabled
    if (FIREBASE_ENABLED && !FirebaseManager) {
      await initFirebase();
    }
    
    // Load from Firestore if Firebase is enabled
    if (FIREBASE_ENABLED && FirebaseManager) {
      console.log('Loading data from Firestore...');
      
      const datasets = ['guests', 'characters', 'decor', 'vendors', 'menu', 'schedule', 'story', 'clues', 'packets'];
      const loaded = {};
      let anyDataLoaded = false;
      
      for (const dataset of datasets) {
        const data = await FirebaseManager.loadData(dataset);
        if (data !== null) {
          loaded[dataset] = data;
          anyDataLoaded = true;
        }
      }
      
      // If any data was loaded from Firestore, use it
      if (anyDataLoaded) {
        AppData.guests = loaded.guests || AppData.guests;
        AppData.characters = loaded.characters || AppData.characters;
        AppData.decor = loaded.decor || AppData.decor;
        AppData.vendors = loaded.vendors || AppData.vendors;
        AppData.menu = loaded.menu || AppData.menu;
        AppData.schedule = loaded.schedule || AppData.schedule;
        AppData.story = loaded.story || AppData.story;
        AppData.clues = loaded.clues || AppData.clues;
        AppData.packets = loaded.packets || AppData.packets;
        
        // Set up real-time listeners for all datasets
        for (const dataset of datasets) {
          FirebaseManager.listenToData(dataset, (data) => {
            AppData[dataset] = data;
            // Re-render the page if needed
            if (typeof window.renderCurrentPage === 'function') {
              window.renderCurrentPage();
            }
          });
        }
        
        console.log('Data loaded from Firestore');
      }
    }
    
    // Fall back to JSON files if no Firestore data or Firebase disabled
    if (!FIREBASE_ENABLED || !FirebaseManager || AppData.guests.length === 0) {
      console.log('Loading data from JSON files...');
      const [guests, characters, decor, vendors, menu, schedule, story, clues, packets] = await Promise.all([
        fetch('./data/guests.json').then(r => r.json()),
        fetch('./data/characters.json').then(r => r.json()),
        fetch('./data/decor.json').then(r => r.json()),
        fetch('./data/vendors.json').then(r => r.json()),
        fetch('./data/menu.json').then(r => r.json()),
        fetch('./data/schedule.json').then(r => r.json()),
        fetch('./data/story.json').then(r => r.json()),
        fetch('./data/clues.json').then(r => r.json()),
        fetch('./data/packets.json').then(r => r.json())
      ]);
      
      AppData.guests = guests;
      AppData.characters = characters;
      AppData.decor = decor;
      AppData.vendors = vendors;
      AppData.menu = menu;
      AppData.schedule = schedule;
      AppData.story = story;
      AppData.clues = clues;
      AppData.packets = packets;
      
      // If Firebase is enabled, save the initial data to Firestore
      if (FIREBASE_ENABLED && FirebaseManager) {
        console.log('Initializing Firestore with JSON data...');
        await Promise.all([
          FirebaseManager.saveData('guests', guests),
          FirebaseManager.saveData('characters', characters),
          FirebaseManager.saveData('decor', decor),
          FirebaseManager.saveData('vendors', vendors),
          FirebaseManager.saveData('menu', menu),
          FirebaseManager.saveData('schedule', schedule),
          FirebaseManager.saveData('story', story),
          FirebaseManager.saveData('clues', clues),
          FirebaseManager.saveData('packets', packets)
        ]);
      }
    }
    
    // Store defaults for reset functionality
    if (!AppData.defaults.guests) {
      const [guests, characters, decor, vendors, menu, schedule, story, clues, packets] = await Promise.all([
        fetch('./data/guests.json').then(r => r.json()),
        fetch('./data/characters.json').then(r => r.json()),
        fetch('./data/decor.json').then(r => r.json()),
        fetch('./data/vendors.json').then(r => r.json()),
        fetch('./data/menu.json').then(r => r.json()),
        fetch('./data/schedule.json').then(r => r.json()),
        fetch('./data/story.json').then(r => r.json()),
        fetch('./data/clues.json').then(r => r.json()),
        fetch('./data/packets.json').then(r => r.json())
      ]);
      
      AppData.defaults = {
        guests: JSON.parse(JSON.stringify(guests)),
        characters: JSON.parse(JSON.stringify(characters)),
        decor: JSON.parse(JSON.stringify(decor)),
        vendors: JSON.parse(JSON.stringify(vendors)),
        menu: JSON.parse(JSON.stringify(menu)),
        schedule: JSON.parse(JSON.stringify(schedule)),
        story: JSON.parse(JSON.stringify(story)),
        clues: JSON.parse(JSON.stringify(clues)),
        packets: JSON.parse(JSON.stringify(packets))
      };
    }
    
    return true;
  } catch (error) {
    console.error('Error loading data:', error);
    return false;
  }
}

// Initialize app
async function initApp() {
  const loaded = await loadData();
  
  if (!loaded) {
    document.body.innerHTML = `
      <div class="container">
        <div class="alert alert-danger">
          <strong>Error:</strong> Failed to load data. Please ensure all data files are present.
        </div>
      </div>
    `;
    return;
  }
  
  // Set active nav link
  setActiveNavLink();
  
  // Render page-specific content
  const page = getPageName();
  if (window.renderPage && typeof window.renderPage === 'function') {
    window.renderPage(page);
  }
}

// Get current page name from URL
function getPageName() {
  const path = window.location.pathname;
  const page = path.split('/').pop().replace('.html', '') || 'index';
  return page;
}

// Set active navigation link
function setActiveNavLink() {
  const page = getPageName();
  const links = document.querySelectorAll('nav a');
  
  links.forEach(link => {
    const href = link.getAttribute('href');
    if (href === `${page}.html` || (page === 'index' && href === 'index.html')) {
      link.classList.add('active');
    }
  });
}

// Helper function to format date
function formatDate(dateString) {
  if (!dateString) return 'Not set';
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', { 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
  });
}

// Helper function to calculate stats
function calculateStats() {
  // Helper to check if guest has a valid address
  const hasValidAddress = (guest) => {
    return guest.address && 
           guest.address.street && 
           guest.address.street !== 'TBD' &&
           guest.address.city &&
           guest.address.state;
  };
  
  // Helper to check if guest has RSVP status (not pending/invited)
  const hasRsvp = (guest) => {
    const rsvpLower = (guest.rsvp || 'pending').toLowerCase();
    return rsvpLower === 'confirmed' || rsvpLower === 'tentative' || rsvpLower === 'not attending';
  };
  
  const guestsWithAddress = AppData.guests.filter(hasValidAddress).length;
  const guestsWithRsvp = AppData.guests.filter(hasRsvp).length;
  
  return {
    totalGuests: AppData.guests.length,
    confirmedGuests: AppData.guests.filter(g => g.rsvp === 'confirmed').length,
    pendingGuests: AppData.guests.filter(g => g.rsvp === 'pending' || g.rsvp === 'invited').length,
    assignedCharacters: AppData.guests.filter(g => g.assignedCharacter).length,
    availableCharacters: AppData.characters.length,
    menuItems: AppData.menu.menuItems ? AppData.menu.menuItems.length : 0,
    decorItems: AppData.decor.shoppingList ? 
      AppData.decor.shoppingList.reduce((sum, cat) => sum + cat.items.length, 0) : 0,
    guestsWithAddress: guestsWithAddress,
    guestsWithRsvp: guestsWithRsvp,
    percentWithAddress: AppData.guests.length > 0 ? Math.round((guestsWithAddress / AppData.guests.length) * 100) : 0,
    percentWithRsvp: AppData.guests.length > 0 ? Math.round((guestsWithRsvp / AppData.guests.length) * 100) : 0
  };
}

// Auto-assign characters to guests
function autoAssignCharacters() {
  const unassignedGuests = AppData.guests.filter(g => !g.assignedCharacter);
  const availableCharacters = [...AppData.characters];
  
  if (unassignedGuests.length > availableCharacters.length) {
    const excess = unassignedGuests.length - availableCharacters.length;
    alert(`Warning: ${excess} guest(s) cannot be assigned. There are more guests than available characters. Consider adding more character roles or having guests share roles.`);
  }
  
  unassignedGuests.forEach((guest, index) => {
    if (index < availableCharacters.length) {
      guest.assignedCharacter = availableCharacters[index].id;
    }
  });
  
  return true;
}

// Generate character packet for printing
function generateCharacterPacket(guestId) {
  const guest = AppData.guests.find(g => g.id === guestId);
  if (!guest || !guest.assignedCharacter) return null;
  
  const character = AppData.characters.find(c => c.id === guest.assignedCharacter);
  if (!character) return null;
  
  return {
    guest: guest,
    character: character
  };
}

// Copy formatted invite text
function generateInviteText(guestId) {
  const guest = AppData.guests.find(g => g.id === guestId);
  if (!guest) return '';
  
  const character = guest.assignedCharacter ? 
    AppData.characters.find(c => c.id === guest.assignedCharacter) : null;
  
  let invite = `Dear ${guest.name},\n\n`;
  invite += `ðŸŒ² You're Invited to "A Damn Fine Bridal Party" ðŸŒ²\n`;
  invite += `A Twin Peaks Mystery Celebration for Marlena\n\n`;
  invite += `"The owls are not what they seem..."\n\n`;
  
  if (character) {
    const packet = getPacketForCharacter(character.id);
    if (packet && packet.intro_profile) {
      invite += `ðŸŽ­ YOUR SECRET CHARACTER ASSIGNMENT:\n`;
      invite += `${packet.intro_profile.name} - ${packet.intro_profile.role}\n`;
      invite += `"${packet.intro_profile.tagline}"\n\n`;
      invite += `${packet.intro_profile.overview}\n\n`;
      invite += `Costume Essentials: ${packet.intro_profile.costume_essentials.join(', ')}\n\n`;
      invite += `Come prepared to solve a mystery and stay in character!\n\n`;
    } else {
      invite += `ðŸŽ­ YOUR SECRET CHARACTER ASSIGNMENT:\n`;
      invite += `${character.name} - ${character.role}\n`;
      invite += `Come prepared to solve a mystery and stay in character!\n\n`;
    }
  }
  
  invite += `Join us for:\n`;
  invite += `â˜• Damn fine coffee and cherry pie\n`;
  invite += `ðŸ” An immersive murder mystery experience\n`;
  invite += `ðŸŽ‰ Celebration, secrets, and surprises\n`;
  invite += `ðŸŒ² Twin Peaks atmosphere and Pacific Northwest charm\n\n`;
  
  invite += `ðŸ“… Date & Time: [TO BE ANNOUNCED]\n`;
  invite += `ðŸ“ Location: [TO BE ANNOUNCED]\n`;
  invite += `ðŸ”— RSVP: [LINK TO BE PROVIDED]\n\n`;
  
  if (guest.dietary && guest.dietary !== 'None') {
    invite += `We have your dietary needs noted: ${guest.dietary}\n\n`;
  }
  
  invite += `Dress Code: Channel your inner Twin Peaks character!\n`;
  invite += `Think 1950s Pacific Northwest - plaid, vintage, mysterious elegance.\n\n`;
  
  invite += `"Every day, once a day, give yourself a present."\n`;
  invite += `- Special Agent Dale Cooper\n\n`;
  
  invite += `See you in the woods! ðŸŒ²ðŸ¦‰\n`;
  
  return invite;
}

// Validate data integrity
function validateData() {
  const errors = [];
  
  // Check for duplicate guest IDs
  const guestIds = AppData.guests.map(g => g.id);
  const duplicateGuests = guestIds.filter((id, index) => guestIds.indexOf(id) !== index);
  if (duplicateGuests.length > 0) {
    errors.push(`Duplicate guest IDs found: ${duplicateGuests.join(', ')}`);
  }
  
  // Check for duplicate character IDs
  const charIds = AppData.characters.map(c => c.id);
  const duplicateChars = charIds.filter((id, index) => charIds.indexOf(id) !== index);
  if (duplicateChars.length > 0) {
    errors.push(`Duplicate character IDs found: ${duplicateChars.join(', ')}`);
  }
  
  // Check for invalid character assignments
  AppData.guests.forEach(guest => {
    if (guest.assignedCharacter && !AppData.characters.find(c => c.id === guest.assignedCharacter)) {
      errors.push(`Guest ${guest.name} assigned to non-existent character: ${guest.assignedCharacter}`);
    }
  });
  
  return errors;
}

// ============================================================================
// GUEST CRUD FUNCTIONS
// ============================================================================

// Show add guest form in a modal/dialog
function showAddGuestForm() {
  const formHtml = `
    <div id="guest-editor-modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 9999; display: flex; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;">
      <div style="background: white; padding: 30px; border-radius: 10px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto;">
        <h2 style="margin-top: 0; color: var(--deep-cherry-red);">Add New Guest</h2>
        <form id="guest-form" onsubmit="handleSaveGuest(event, null)">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div style="grid-column: 1 / -1;">
              <label><strong>Name *</strong></label>
              <input type="text" name="name" required style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label><strong>Email</strong></label>
              <input type="email" name="email" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label><strong>Phone</strong></label>
              <input type="tel" name="phone" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="grid-column: 1 / -1;">
              <label><strong>Address</strong></label>
              <input type="text" name="street" placeholder="Street" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
              <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; margin-top: 5px;">
                <input type="text" name="city" placeholder="City" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <input type="text" name="state" placeholder="State" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <input type="text" name="zip" placeholder="ZIP" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
              <input type="text" name="country" placeholder="Country" value="USA" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label><strong>RSVP Status</strong></label>
              <select name="rsvp" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="pending">Pending</option>
                <option value="invited">Invited</option>
                <option value="confirmed">Confirmed</option>
                <option value="tentative">Tentative</option>
                <option value="not attending">Not Attending</option>
              </select>
            </div>
            <div>
              <label><strong>Assigned Character</strong></label>
              <select name="assignedCharacter" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">None</option>
                ${AppData.characters.map(c => `<option value="${c.id}">${c.name} (${c.role})</option>`).join('')}
              </select>
            </div>
            <div>
              <label><strong>Dietary Restrictions</strong></label>
              <input type="text" name="dietary" placeholder="e.g., Vegetarian, Gluten-free" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label><strong>Dietary Severity</strong></label>
              <select name="dietarySeverity" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">None</option>
                <option value="allergy">Allergy</option>
                <option value="intolerance">Intolerance</option>
                <option value="preference">Preference</option>
              </select>
            </div>
            <div style="grid-column: 1 / -1;">
              <label><strong>Accessibility Needs</strong></label>
              <input type="text" name="accessibility" placeholder="e.g., Wheelchair accessible seating" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="grid-column: 1 / -1;">
              <label><strong>Role Vibe / Personality</strong></label>
              <input type="text" name="roleVibe" placeholder="e.g., warm and friendly, mysterious and analytical" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="grid-column: 1 / -1;">
              <label><strong>Seating Preferences</strong></label>
              <input type="text" name="seatingPreferences" placeholder="e.g., Sit with Sarah, Avoid Alex" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="grid-column: 1 / -1;">
              <label><strong>Notes</strong></label>
              <textarea name="notes" rows="3" placeholder="Any additional notes" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
            </div>
          </div>
          <div style="margin-top: 20px; text-align: right;">
            <button type="button" onclick="closeGuestEditor()" class="btn btn-secondary" style="margin-right: 10px;">Cancel</button>
            <button type="submit" class="btn">Save Guest</button>
          </div>
        </form>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', formHtml);
}

// Edit existing guest
function editGuest(guestId) {
  const guest = AppData.guests.find(g => g.id === guestId);
  if (!guest) return;
  
  const formHtml = `
    <div id="guest-editor-modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 9999; display: flex; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;">
      <div style="background: white; padding: 30px; border-radius: 10px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto;">
        <h2 style="margin-top: 0; color: var(--deep-cherry-red);">Edit Guest: ${guest.name}</h2>
        <form id="guest-form" onsubmit="handleSaveGuest(event, ${guestId})">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div style="grid-column: 1 / -1;">
              <label><strong>Name *</strong></label>
              <input type="text" name="name" value="${guest.name || ''}" required style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label><strong>Email</strong></label>
              <input type="email" name="email" value="${guest.email || ''}" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label><strong>Phone</strong></label>
              <input type="tel" name="phone" value="${guest.phone || ''}" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="grid-column: 1 / -1;">
              <label><strong>Address</strong></label>
              <input type="text" name="street" placeholder="Street" value="${guest.address?.street || ''}" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
              <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; margin-top: 5px;">
                <input type="text" name="city" placeholder="City" value="${guest.address?.city || ''}" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <input type="text" name="state" placeholder="State" value="${guest.address?.state || ''}" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <input type="text" name="zip" placeholder="ZIP" value="${guest.address?.zip || ''}" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
              <input type="text" name="country" placeholder="Country" value="${guest.address?.country || 'USA'}" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label><strong>RSVP Status</strong></label>
              <select name="rsvp" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="pending" ${guest.rsvp === 'pending' ? 'selected' : ''}>Pending</option>
                <option value="invited" ${guest.rsvp === 'invited' ? 'selected' : ''}>Invited</option>
                <option value="confirmed" ${guest.rsvp === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                <option value="tentative" ${guest.rsvp === 'tentative' ? 'selected' : ''}>Tentative</option>
                <option value="not attending" ${guest.rsvp === 'not attending' ? 'selected' : ''}>Not Attending</option>
              </select>
            </div>
            <div>
              <label><strong>Assigned Character</strong></label>
              <select name="assignedCharacter" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">None</option>
                ${AppData.characters.map(c => `<option value="${c.id}" ${guest.assignedCharacter === c.id ? 'selected' : ''}>${c.name} (${c.role})</option>`).join('')}
              </select>
            </div>
            <div>
              <label><strong>Dietary Restrictions</strong></label>
              <input type="text" name="dietary" value="${guest.dietary || ''}" placeholder="e.g., Vegetarian, Gluten-free" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label><strong>Dietary Severity</strong></label>
              <select name="dietarySeverity" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">None</option>
                <option value="allergy" ${guest.dietarySeverity === 'allergy' ? 'selected' : ''}>Allergy</option>
                <option value="intolerance" ${guest.dietarySeverity === 'intolerance' ? 'selected' : ''}>Intolerance</option>
                <option value="preference" ${guest.dietarySeverity === 'preference' ? 'selected' : ''}>Preference</option>
              </select>
            </div>
            <div style="grid-column: 1 / -1;">
              <label><strong>Accessibility Needs</strong></label>
              <input type="text" name="accessibility" value="${guest.accessibility || ''}" placeholder="e.g., Wheelchair accessible seating" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="grid-column: 1 / -1;">
              <label><strong>Role Vibe / Personality</strong></label>
              <input type="text" name="roleVibe" value="${guest.roleVibe || ''}" placeholder="e.g., warm and friendly, mysterious and analytical" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="grid-column: 1 / -1;">
              <label><strong>Seating Preferences</strong></label>
              <input type="text" name="seatingPreferences" value="${guest.seatingPreferences || ''}" placeholder="e.g., Sit with Sarah, Avoid Alex" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="grid-column: 1 / -1;">
              <label><strong>Notes</strong></label>
              <textarea name="notes" rows="3" placeholder="Any additional notes" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">${guest.notes || ''}</textarea>
            </div>
          </div>
          <div style="margin-top: 20px; text-align: right;">
            <button type="button" onclick="closeGuestEditor()" class="btn btn-secondary" style="margin-right: 10px;">Cancel</button>
            <button type="submit" class="btn">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', formHtml);
}

// Handle save guest (add or edit)
function handleSaveGuest(event, guestId) {
  event.preventDefault();
  const form = event.target;
  const formData = new FormData(form);
  
  const guestData = {
    name: formData.get('name'),
    email: formData.get('email') || null,
    phone: formData.get('phone') || null,
    address: {
      street: formData.get('street') || '',
      city: formData.get('city') || '',
      state: formData.get('state') || '',
      zip: formData.get('zip') || '',
      country: formData.get('country') || 'USA'
    },
    rsvp: formData.get('rsvp') || 'pending',
    dietary: formData.get('dietary') || 'None',
    dietarySeverity: formData.get('dietarySeverity') || null,
    accessibility: formData.get('accessibility') || 'None',
    roleVibe: formData.get('roleVibe') || null,
    seatingPreferences: formData.get('seatingPreferences') || null,
    notes: formData.get('notes') || null,
    assignedCharacter: formData.get('assignedCharacter') || null
  };
  
  if (guestId === null) {
    // Add new guest with safer ID generation
    const existingIds = AppData.guests.filter(g => g.id != null).map(g => g.id);
    const newId = existingIds.length > 0 ? Math.max(...existingIds) + 1 : 1;
    guestData.id = newId;
    AppData.guests.push(guestData);
  } else {
    // Update existing guest
    const index = AppData.guests.findIndex(g => g.id === guestId);
    if (index !== -1) {
      AppData.guests[index] = { ...AppData.guests[index], ...guestData };
    }
  }
  
  saveToLocalStorage();
  closeGuestEditor();
  
  // Re-render guests table
  if (window.Render && window.Render.guests) {
    window.Render.guests();
  }
  
  // Update stats if they exist
  const stats = calculateStats();
  if (document.getElementById('stat-total')) {
    document.getElementById('stat-total').textContent = stats.totalGuests;
    document.getElementById('stat-confirmed').textContent = stats.confirmedGuests;
    document.getElementById('stat-assigned').textContent = stats.assignedCharacters;
    document.getElementById('stat-pending').textContent = stats.pendingGuests;
  }
}

// Delete guest with confirmation
function deleteGuest(guestId) {
  const guest = AppData.guests.find(g => g.id === guestId);
  if (!guest) return;
  
  if (confirm(`Are you sure you want to delete ${guest.name}? This cannot be undone.`)) {
    AppData.guests = AppData.guests.filter(g => g.id !== guestId);
    saveToLocalStorage();
    
    // Re-render
    if (window.Render && window.Render.guests) {
      window.Render.guests();
    }
    
    // Update stats
    const stats = calculateStats();
    if (document.getElementById('stat-total')) {
      document.getElementById('stat-total').textContent = stats.totalGuests;
      document.getElementById('stat-confirmed').textContent = stats.confirmedGuests;
      document.getElementById('stat-assigned').textContent = stats.assignedCharacters;
      document.getElementById('stat-pending').textContent = stats.pendingGuests;
    }
  }
}

// Close guest editor modal
function closeGuestEditor() {
  const modal = document.getElementById('guest-editor-modal');
  if (modal) {
    modal.remove();
  }
}

// Handle autosave toggle
function handleAutosaveToggle() {
  const enabled = toggleAutosave();
  const toggles = document.querySelectorAll('[id^="autosave-toggle"]');
  toggles.forEach(toggle => {
    toggle.checked = enabled;
  });
  
  const message = enabled ? 
    'Autosave enabled! Your changes will be saved to browser storage.' : 
    'Autosave disabled. Use Export to save your data.';
  alert(message);
}

// Handle import guests
async function handleImportGuests() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    try {
      const data = await importDataset('guests', file);
      
      // Show preview
      if (confirm(`Import ${data.length} guests? This will replace your current guest list.`)) {
        applyImportedData('guests', data);
        
        // Re-render
        if (window.Render && window.Render.guests) {
          window.Render.guests();
        }
        
        // Update stats
        const stats = calculateStats();
        if (document.getElementById('stat-total')) {
          document.getElementById('stat-total').textContent = stats.totalGuests;
          document.getElementById('stat-confirmed').textContent = stats.confirmedGuests;
          document.getElementById('stat-assigned').textContent = stats.assignedCharacters;
          document.getElementById('stat-pending').textContent = stats.pendingGuests;
        }
        
        alert('Guests imported successfully!');
      }
    } catch (error) {
      alert(`Import failed: ${error.message}`);
    }
  };
  
  input.click();
}

// Handle reset guests
async function handleResetGuests() {
  if (confirm('Reset guests to repository defaults? This will discard all changes.')) {
    await resetToDefaults('guests');
    
    // Re-render
    if (window.Render && window.Render.guests) {
      window.Render.guests();
    }
    
    // Update stats
    const stats = calculateStats();
    if (document.getElementById('stat-total')) {
      document.getElementById('stat-total').textContent = stats.totalGuests;
      document.getElementById('stat-confirmed').textContent = stats.confirmedGuests;
      document.getElementById('stat-assigned').textContent = stats.assignedCharacters;
      document.getElementById('stat-pending').textContent = stats.pendingGuests;
    }
    
    alert('Guests reset to defaults!');
  }
}

// Decor functions
function toggleDecorFavorite(itemId) {
  if (AppData.decorFavorites.has(itemId)) {
    AppData.decorFavorites.delete(itemId);
  } else {
    AppData.decorFavorites.add(itemId);
  }
}

function toggleDecorShoppingList(itemId) {
  if (AppData.decorShoppingList.has(itemId)) {
    AppData.decorShoppingList.delete(itemId);
  } else {
    AppData.decorShoppingList.add(itemId);
  }
}

// Menu functions
function toggleMenuFavorite(itemId) {
  if (AppData.menuFavorites.has(itemId)) {
    AppData.menuFavorites.delete(itemId);
  } else {
    AppData.menuFavorites.add(itemId);
  }
}

function toggleMenuFeatured(itemId) {
  if (AppData.menuFeatured.has(itemId)) {
    AppData.menuFeatured.delete(itemId);
  } else {
    AppData.menuFeatured.add(itemId);
  }
}

// ============================================================================
// MENU ITEM CRUD FUNCTIONS
// ============================================================================

// Show add menu item form
function showAddMenuItemForm() {
  // Get existing categories for dropdown
  const categories = [...new Set(AppData.menu.menuItems.map(item => item.category))].sort();
  
  const formHtml = `
    <div id="menu-editor-modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 9999; display: flex; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;">
      <div style="background: white; padding: 30px; border-radius: 10px; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto;">
        <h2 style="margin-top: 0; color: var(--deep-cherry-red);">Add New Menu Item</h2>
        <form id="menu-form" onsubmit="handleSaveMenuItem(event, null)">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div style="grid-column: 1 / -1;">
              <label><strong>Name *</strong></label>
              <input type="text" name="name" required style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label><strong>Category *</strong></label>
              <input type="text" name="category" list="category-list" required placeholder="e.g., Appetizer, Main, Dessert" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
              <datalist id="category-list">
                ${categories.map(cat => `<option value="${cat}">`).join('')}
                <option value="Appetizer">
                <option value="Main">
                <option value="Side">
                <option value="Dessert">
                <option value="Beverage">
              </datalist>
            </div>
            <div>
              <label><strong>Serves</strong></label>
              <input type="text" name="serves" placeholder="e.g., 35 or unlimited" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="grid-column: 1 / -1;">
              <label><strong>Description</strong></label>
              <textarea name="description" rows="3" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
            </div>
            <div>
              <label><strong>Prep Time</strong></label>
              <input type="text" name="prepTime" placeholder="e.g., 30 minutes" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label><strong>Allergens</strong></label>
              <input type="text" name="allergens" placeholder="Comma-separated, e.g., Gluten, Dairy" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="grid-column: 1 / -1;">
              <label><strong>Dietary Options</strong></label>
              <input type="text" name="dietaryOptions" placeholder="Comma-separated, e.g., Can be made vegan, Gluten-free available" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
          </div>
          <div style="margin-top: 20px; text-align: right;">
            <button type="button" onclick="closeMenuEditor()" class="btn btn-secondary" style="margin-right: 10px;">Cancel</button>
            <button type="submit" class="btn">Save Menu Item</button>
          </div>
        </form>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', formHtml);
}

// Edit existing menu item
function editMenuItem(itemId) {
  const item = AppData.menu.menuItems.find(i => i.id === itemId);
  if (!item) return;
  
  // Get existing categories for dropdown
  const categories = [...new Set(AppData.menu.menuItems.map(item => item.category))].sort();
  
  const formHtml = `
    <div id="menu-editor-modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 9999; display: flex; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;">
      <div style="background: white; padding: 30px; border-radius: 10px; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto;">
        <h2 style="margin-top: 0; color: var(--deep-cherry-red);">Edit Menu Item: ${item.name}</h2>
        <form id="menu-form" onsubmit="handleSaveMenuItem(event, '${itemId}')">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div style="grid-column: 1 / -1;">
              <label><strong>Name *</strong></label>
              <input type="text" name="name" value="${item.name || ''}" required style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label><strong>Category *</strong></label>
              <input type="text" name="category" value="${item.category || ''}" list="category-list" required placeholder="e.g., Appetizer, Main, Dessert" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
              <datalist id="category-list">
                ${categories.map(cat => `<option value="${cat}">`).join('')}
                <option value="Appetizer">
                <option value="Main">
                <option value="Side">
                <option value="Dessert">
                <option value="Beverage">
              </datalist>
            </div>
            <div>
              <label><strong>Serves</strong></label>
              <input type="text" name="serves" value="${item.serves || ''}" placeholder="e.g., 35 or unlimited" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="grid-column: 1 / -1;">
              <label><strong>Description</strong></label>
              <textarea name="description" rows="3" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">${item.description || ''}</textarea>
            </div>
            <div>
              <label><strong>Prep Time</strong></label>
              <input type="text" name="prepTime" value="${item.prepTime || ''}" placeholder="e.g., 30 minutes" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label><strong>Allergens</strong></label>
              <input type="text" name="allergens" value="${(item.allergens || []).join(', ')}" placeholder="Comma-separated, e.g., Gluten, Dairy" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="grid-column: 1 / -1;">
              <label><strong>Dietary Options</strong></label>
              <input type="text" name="dietaryOptions" value="${(item.dietaryOptions || []).join(', ')}" placeholder="Comma-separated, e.g., Can be made vegan, Gluten-free available" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
          </div>
          <div style="margin-top: 20px; text-align: right;">
            <button type="button" onclick="closeMenuEditor()" class="btn btn-secondary" style="margin-right: 10px;">Cancel</button>
            <button type="submit" class="btn">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', formHtml);
}

// Handle save menu item (add or edit)
function handleSaveMenuItem(event, itemId) {
  event.preventDefault();
  const form = event.target;
  const formData = new FormData(form);
  
  const itemData = {
    name: formData.get('name'),
    category: formData.get('category'),
    description: formData.get('description') || '',
    serves: formData.get('serves') || '',
    prepTime: formData.get('prepTime') || '',
    allergens: formData.get('allergens') ? formData.get('allergens').split(',').map(s => s.trim()).filter(s => s) : [],
    dietaryOptions: formData.get('dietaryOptions') ? formData.get('dietaryOptions').split(',').map(s => s.trim()).filter(s => s) : []
  };
  
  if (itemId === null) {
    // Add new menu item with more robust ID generation
    const newId = 'menu-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    itemData.id = newId;
    AppData.menu.menuItems.push(itemData);
  } else {
    // Update existing menu item
    const index = AppData.menu.menuItems.findIndex(i => i.id === itemId);
    if (index !== -1) {
      AppData.menu.menuItems[index] = { ...AppData.menu.menuItems[index], ...itemData };
    }
  }
  
  saveToLocalStorage();
  closeMenuEditor();
  
  // Re-render menu
  if (window.Render && window.Render.food) {
    window.Render.food();
  }
}

// Delete menu item with confirmation
function deleteMenuItem(itemId) {
  const item = AppData.menu.menuItems.find(i => i.id === itemId);
  if (!item) return;
  
  if (confirm(`Are you sure you want to delete "${item.name}"? This cannot be undone.`)) {
    AppData.menu.menuItems = AppData.menu.menuItems.filter(i => i.id !== itemId);
    
    // Also remove from favorites/featured sets
    AppData.menuFavorites.delete(itemId);
    AppData.menuFeatured.delete(itemId);
    
    saveToLocalStorage();
    
    // Re-render
    if (window.Render && window.Render.food) {
      window.Render.food();
    }
  }
}

// Close menu editor modal
function closeMenuEditor() {
  const modal = document.getElementById('menu-editor-modal');
  if (modal) {
    modal.remove();
  }
}

// Handle import menu
async function handleImportMenu() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    try {
      const data = await importDataset('menu', file);
      
      // Show preview
      if (confirm(`Import menu with ${data.menuItems ? data.menuItems.length : 0} items? This will replace your current menu.`)) {
        applyImportedData('menu', data);
        
        // Re-render
        if (window.Render && window.Render.food) {
          window.Render.food();
        }
        
        alert('Menu imported successfully!');
      }
    } catch (error) {
      alert(`Import failed: ${error.message}`);
    }
  };
  
  input.click();
}

// Handle reset menu
async function handleResetMenu() {
  if (confirm('Reset menu to repository defaults? This will discard all changes.')) {
    await resetToDefaults('menu');
    
    // Re-render
    if (window.Render && window.Render.food) {
      window.Render.food();
    }
    
    alert('Menu reset to defaults!');
  }
}

// ============================================================================
// ADMIN DATA MANAGER FUNCTIONS
// ============================================================================

// Generic export handler for admin panel
function handleExportDataset(datasetName) {
  switch(datasetName) {
    case 'guests':
      exportGuests();
      break;
    case 'characters':
      exportCharacters();
      break;
    case 'decor':
      exportDecor();
      break;
    case 'vendors':
      exportVendors();
      break;
    case 'menu':
      exportMenu();
      break;
    case 'schedule':
      exportSchedule();
      break;
    case 'story':
      exportStory();
      break;
    case 'clues':
      exportClues();
      break;
    case 'packets':
      exportPackets();
      break;
    default:
      alert(`Unknown dataset: ${datasetName}`);
  }
}

// Generic import handler for admin panel
async function handleImportDataset(datasetName) {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    try {
      const data = await importDataset(datasetName, file);
      
      // Determine count for confirmation
      let count = 0;
      if (Array.isArray(data)) {
        count = data.length;
      } else if (data.menuItems) {
        count = data.menuItems.length;
      } else if (data.timeline) {
        count = data.timeline.length;
      } else if (data.moodBoard) {
        count = data.moodBoard.length;
      }
      
      const message = count > 0 ? 
        `Import ${count} items from ${datasetName}.json? This will replace your current data.` :
        `Import ${datasetName}.json? This will replace your current data.`;
      
      if (confirm(message)) {
        applyImportedData(datasetName, data);
        
        // Re-render if current page matches
        const page = getPageName();
        if (window.Render && window.Render[page]) {
          window.Render[page]();
        }
        
        alert(`${datasetName} imported successfully!`);
      }
    } catch (error) {
      alert(`Import failed: ${error.message}`);
    }
  };
  
  input.click();
}

// Generic reset handler for admin panel
async function handleResetDataset(datasetName) {
  if (confirm(`Reset ${datasetName} to repository defaults? This will discard all changes.`)) {
    await resetToDefaults(datasetName);
    
    // Re-render if current page matches
    const page = getPageName();
    if (window.Render && window.Render[page]) {
      window.Render[page]();
    }
    
    alert(`${datasetName} reset to defaults!`);
  }
}

// ============================================================================
// DECOR CRUD FUNCTIONS
// ============================================================================

// Add mood board
function showAddMoodBoardForm() {
  const formHtml = `
    <div id="decor-editor-modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 9999; display: flex; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;">
      <div style="background: white; padding: 30px; border-radius: 10px; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto;">
        <h2 style="margin-top: 0; color: var(--deep-cherry-red);">Add New Mood Board</h2>
        <form id="mood-form" onsubmit="handleSaveMoodBoard(event, null)">
          <div style="display: grid; gap: 15px;">
            <div>
              <label><strong>Name *</strong></label>
              <input type="text" name="name" required style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label><strong>Description</strong></label>
              <textarea name="description" rows="3" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
            </div>
            <div>
              <label><strong>Colors (comma-separated hex codes)</strong></label>
              <input type="text" name="colors" placeholder="e.g., #8B0000, #C79810, #2C1810" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label><strong>Items (comma-separated)</strong></label>
              <textarea name="items" rows="3" placeholder="e.g., Burgundy velvet curtains, Gold candelabras" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
            </div>
          </div>
          <div style="margin-top: 20px; text-align: right;">
            <button type="button" onclick="closeDecorEditor()" class="btn btn-secondary" style="margin-right: 10px;">Cancel</button>
            <button type="submit" class="btn">Save Mood Board</button>
          </div>
        </form>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', formHtml);
}

function editMoodBoard(moodId) {
  const mood = AppData.decor.moodBoard.find(m => m.id === moodId);
  if (!mood) return;
  
  const formHtml = `
    <div id="decor-editor-modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 9999; display: flex; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;">
      <div style="background: white; padding: 30px; border-radius: 10px; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto;">
        <h2 style="margin-top: 0; color: var(--deep-cherry-red);">Edit Mood Board: ${mood.name}</h2>
        <form id="mood-form" onsubmit="handleSaveMoodBoard(event, '${moodId}')">
          <div style="display: grid; gap: 15px;">
            <div>
              <label><strong>Name *</strong></label>
              <input type="text" name="name" value="${mood.name}" required style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label><strong>Description</strong></label>
              <textarea name="description" rows="3" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">${mood.description || ''}</textarea>
            </div>
            <div>
              <label><strong>Colors (comma-separated hex codes)</strong></label>
              <input type="text" name="colors" value="${mood.colors.join(', ')}" placeholder="e.g., #8B0000, #C79810, #2C1810" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label><strong>Items (comma-separated)</strong></label>
              <textarea name="items" rows="3" placeholder="e.g., Burgundy velvet curtains, Gold candelabras" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">${mood.items.join(', ')}</textarea>
            </div>
          </div>
          <div style="margin-top: 20px; text-align: right;">
            <button type="button" onclick="closeDecorEditor()" class="btn btn-secondary" style="margin-right: 10px;">Cancel</button>
            <button type="submit" class="btn">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', formHtml);
}

function handleSaveMoodBoard(event, moodId) {
  event.preventDefault();
  const form = event.target;
  const formData = new FormData(form);
  
  const moodData = {
    name: formData.get('name'),
    description: formData.get('description') || '',
    colors: formData.get('colors') ? formData.get('colors').split(',').map(s => s.trim()).filter(s => s) : [],
    items: formData.get('items') ? formData.get('items').split(',').map(s => s.trim()).filter(s => s) : []
  };
  
  if (moodId === null) {
    const newId = 'mood-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    moodData.id = newId;
    AppData.decor.moodBoard.push(moodData);
  } else {
    const index = AppData.decor.moodBoard.findIndex(m => m.id === moodId);
    if (index !== -1) {
      AppData.decor.moodBoard[index] = { ...AppData.decor.moodBoard[index], ...moodData };
    }
  }
  
  saveToLocalStorage();
  closeDecorEditor();
  
  if (window.Render && window.Render.decor) {
    window.Render.decor();
  }
}

function deleteMoodBoard(moodId) {
  const mood = AppData.decor.moodBoard.find(m => m.id === moodId);
  if (!mood) return;
  
  if (confirm(`Delete "${mood.name}" mood board?`)) {
    AppData.decor.moodBoard = AppData.decor.moodBoard.filter(m => m.id !== moodId);
    AppData.decorFavorites.delete(moodId);
    AppData.decorShoppingList.delete(moodId);
    saveToLocalStorage();
    
    if (window.Render && window.Render.decor) {
      window.Render.decor();
    }
  }
}

// Shopping list CRUD
function showAddShoppingCategoryForm() {
  const formHtml = `
    <div id="decor-editor-modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 9999; display: flex; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;">
      <div style="background: white; padding: 30px; border-radius: 10px; max-width: 500px; width: 100%;">
        <h2 style="margin-top: 0; color: var(--deep-cherry-red);">Add Shopping Category</h2>
        <form id="category-form" onsubmit="handleSaveShoppingCategory(event)">
          <div>
            <label><strong>Category Name *</strong></label>
            <input type="text" name="category" required placeholder="e.g., Linens, Lighting, Centerpieces" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
          <div style="margin-top: 20px; text-align: right;">
            <button type="button" onclick="closeDecorEditor()" class="btn btn-secondary" style="margin-right: 10px;">Cancel</button>
            <button type="submit" class="btn">Add Category</button>
          </div>
        </form>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', formHtml);
}

function handleSaveShoppingCategory(event) {
  event.preventDefault();
  const form = event.target;
  const formData = new FormData(form);
  
  AppData.decor.shoppingList.push({
    category: formData.get('category'),
    items: []
  });
  
  saveToLocalStorage();
  closeDecorEditor();
  
  if (window.Render && window.Render.decor) {
    window.Render.decor();
  }
}

function deleteShoppingCategory(catIndex) {
  const category = AppData.decor.shoppingList[catIndex];
  if (confirm(`Delete category "${category.category}" and all its items?`)) {
    AppData.decor.shoppingList.splice(catIndex, 1);
    saveToLocalStorage();
    
    if (window.Render && window.Render.decor) {
      window.Render.decor();
    }
  }
}

function showAddShoppingItemForm(catIndex) {
  const category = AppData.decor.shoppingList[catIndex];
  const formHtml = `
    <div id="decor-editor-modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 9999; display: flex; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;">
      <div style="background: white; padding: 30px; border-radius: 10px; max-width: 600px; width: 100%;">
        <h2 style="margin-top: 0; color: var(--deep-cherry-red);">Add Item to ${category.category}</h2>
        <form id="item-form" onsubmit="handleSaveShoppingItem(event, ${catIndex}, null)">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div style="grid-column: 1 / -1;">
              <label><strong>Item *</strong></label>
              <input type="text" name="item" required style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label><strong>Quantity *</strong></label>
              <input type="text" name="quantity" required placeholder="e.g., 4, bulk" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label><strong>Estimated Cost *</strong></label>
              <input type="number" name="estimated" required min="0" step="0.01" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
          </div>
          <div style="margin-top: 20px; text-align: right;">
            <button type="button" onclick="closeDecorEditor()" class="btn btn-secondary" style="margin-right: 10px;">Cancel</button>
            <button type="submit" class="btn">Add Item</button>
          </div>
        </form>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', formHtml);
}

function editShoppingItem(catIndex, itemIndex) {
  const item = AppData.decor.shoppingList[catIndex].items[itemIndex];
  const category = AppData.decor.shoppingList[catIndex];
  
  const formHtml = `
    <div id="decor-editor-modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 9999; display: flex; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;">
      <div style="background: white; padding: 30px; border-radius: 10px; max-width: 600px; width: 100%;">
        <h2 style="margin-top: 0; color: var(--deep-cherry-red);">Edit ${item.item}</h2>
        <form id="item-form" onsubmit="handleSaveShoppingItem(event, ${catIndex}, ${itemIndex})">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div style="grid-column: 1 / -1;">
              <label><strong>Item *</strong></label>
              <input type="text" name="item" value="${item.item}" required style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label><strong>Quantity *</strong></label>
              <input type="text" name="quantity" value="${item.quantity}" required placeholder="e.g., 4, bulk" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label><strong>Estimated Cost *</strong></label>
              <input type="number" name="estimated" value="${item.estimated}" required min="0" step="0.01" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
          </div>
          <div style="margin-top: 20px; text-align: right;">
            <button type="button" onclick="closeDecorEditor()" class="btn btn-secondary" style="margin-right: 10px;">Cancel</button>
            <button type="submit" class="btn">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', formHtml);
}

function handleSaveShoppingItem(event, catIndex, itemIndex) {
  event.preventDefault();
  const form = event.target;
  const formData = new FormData(form);
  
  const itemData = {
    item: formData.get('item'),
    quantity: formData.get('quantity'),
    estimated: parseFloat(formData.get('estimated')),
    purchased: itemIndex !== null ? AppData.decor.shoppingList[catIndex].items[itemIndex].purchased : false
  };
  
  if (itemIndex === null) {
    AppData.decor.shoppingList[catIndex].items.push(itemData);
  } else {
    AppData.decor.shoppingList[catIndex].items[itemIndex] = itemData;
  }
  
  saveToLocalStorage();
  closeDecorEditor();
  
  if (window.Render && window.Render.decor) {
    window.Render.decor();
  }
}

function deleteShoppingItem(catIndex, itemIndex) {
  const item = AppData.decor.shoppingList[catIndex].items[itemIndex];
  if (confirm(`Delete "${item.item}"?`)) {
    AppData.decor.shoppingList[catIndex].items.splice(itemIndex, 1);
    saveToLocalStorage();
    
    if (window.Render && window.Render.decor) {
      window.Render.decor();
    }
  }
}

function togglePurchased(catIndex, itemIndex) {
  AppData.decor.shoppingList[catIndex].items[itemIndex].purchased = 
    !AppData.decor.shoppingList[catIndex].items[itemIndex].purchased;
  saveToLocalStorage();
  
  if (window.Render && window.Render.decor) {
    window.Render.decor();
  }
}

function closeDecorEditor() {
  const modal = document.getElementById('decor-editor-modal');
  if (modal) modal.remove();
}

async function handleImportDecor() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    try {
      const data = await importDataset('decor', file);
      
      if (confirm(`Import decor data with ${data.moodBoard?.length || 0} mood boards and ${data.shoppingList?.length || 0} shopping categories?`)) {
        applyImportedData('decor', data);
        
        if (window.Render && window.Render.decor) {
          window.Render.decor();
        }
        
        alert('Decor imported successfully!');
      }
    } catch (error) {
      alert(`Import failed: ${error.message}`);
    }
  };
  
  input.click();
}

async function handleResetDecor() {
  if (confirm('Reset decor to repository defaults?')) {
    await resetToDefaults('decor');
    
    if (window.Render && window.Render.decor) {
      window.Render.decor();
    }
    
    alert('Decor reset to defaults!');
  }
}

// ============================================================================
// SCHEDULE CRUD FUNCTIONS
// ============================================================================

function showAddTimelineForm() {
  const formHtml = `
    <div id="schedule-editor-modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 9999; display: flex; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;">
      <div style="background: white; padding: 30px; border-radius: 10px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto;">
        <h2 style="margin-top: 0; color: var(--deep-cherry-red);">Add Timeline Item</h2>
        <form id="timeline-form" onsubmit="handleSaveTimelineItem(event, null)">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
              <label><strong>Time *</strong></label>
              <input type="text" name="time" required placeholder="e.g., 0:00 - 0:15" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label><strong>Duration *</strong></label>
              <input type="text" name="duration" required placeholder="e.g., 15 minutes" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="grid-column: 1 / -1;">
              <label><strong>Title *</strong></label>
              <input type="text" name="title" required style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="grid-column: 1 / -1;">
              <label><strong>Description</strong></label>
              <textarea name="description" rows="3" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
            </div>
            <div style="grid-column: 1 / -1;">
              <label><strong>Activities (one per line)</strong></label>
              <textarea name="activities" rows="4" placeholder="Activity 1&#10;Activity 2&#10;Activity 3" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
            </div>
            <div style="grid-column: 1 / -1;">
              <label><strong>Music</strong></label>
              <input type="text" name="music" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label><strong>Phase</strong></label>
              <select name="phase" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">None</option>
                <option value="intro">Intro</option>
                <option value="mid">Mid</option>
                <option value="pre-final">Pre-Final</option>
                <option value="final">Final</option>
              </select>
            </div>
            <div>
              <label><strong>Envelope Instruction</strong></label>
              <input type="text" name="envelope_instruction" placeholder="Optional" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="grid-column: 1 / -1;">
              <label><strong>Notes</strong></label>
              <textarea name="notes" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
            </div>
          </div>
          <div style="margin-top: 20px; text-align: right;">
            <button type="button" onclick="closeScheduleEditor()" class="btn btn-secondary" style="margin-right: 10px;">Cancel</button>
            <button type="submit" class="btn">Add Timeline Item</button>
          </div>
        </form>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', formHtml);
}

function editTimelineItem(index) {
  const item = AppData.schedule.timeline[index];
  
  const formHtml = `
    <div id="schedule-editor-modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 9999; display: flex; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;">
      <div style="background: white; padding: 30px; border-radius: 10px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto;">
        <h2 style="margin-top: 0; color: var(--deep-cherry-red);">Edit Timeline Item</h2>
        <form id="timeline-form" onsubmit="handleSaveTimelineItem(event, ${index})">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
              <label><strong>Time *</strong></label>
              <input type="text" name="time" value="${item.time}" required placeholder="e.g., 0:00 - 0:15" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label><strong>Duration *</strong></label>
              <input type="text" name="duration" value="${item.duration}" required placeholder="e.g., 15 minutes" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="grid-column: 1 / -1;">
              <label><strong>Title *</strong></label>
              <input type="text" name="title" value="${item.title}" required style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="grid-column: 1 / -1;">
              <label><strong>Description</strong></label>
              <textarea name="description" rows="3" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">${item.description || ''}</textarea>
            </div>
            <div style="grid-column: 1 / -1;">
              <label><strong>Activities (one per line)</strong></label>
              <textarea name="activities" rows="4" placeholder="Activity 1&#10;Activity 2&#10;Activity 3" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">${(item.activities || []).join('\n')}</textarea>
            </div>
            <div style="grid-column: 1 / -1;">
              <label><strong>Music</strong></label>
              <input type="text" name="music" value="${item.music || ''}" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label><strong>Phase</strong></label>
              <select name="phase" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">None</option>
                <option value="intro" ${item.phase === 'intro' ? 'selected' : ''}>Intro</option>
                <option value="mid" ${item.phase === 'mid' ? 'selected' : ''}>Mid</option>
                <option value="pre-final" ${item.phase === 'pre-final' ? 'selected' : ''}>Pre-Final</option>
                <option value="final" ${item.phase === 'final' ? 'selected' : ''}>Final</option>
              </select>
            </div>
            <div>
              <label><strong>Envelope Instruction</strong></label>
              <input type="text" name="envelope_instruction" value="${item.envelope_instruction || ''}" placeholder="Optional" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="grid-column: 1 / -1;">
              <label><strong>Notes</strong></label>
              <textarea name="notes" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">${item.notes || ''}</textarea>
            </div>
          </div>
          <div style="margin-top: 20px; text-align: right;">
            <button type="button" onclick="closeScheduleEditor()" class="btn btn-secondary" style="margin-right: 10px;">Cancel</button>
            <button type="submit" class="btn">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', formHtml);
}

function handleSaveTimelineItem(event, index) {
  event.preventDefault();
  const form = event.target;
  const formData = new FormData(form);
  
  const itemData = {
    time: formData.get('time'),
    title: formData.get('title'),
    duration: formData.get('duration'),
    description: formData.get('description') || '',
    activities: formData.get('activities') ? formData.get('activities').split('\n').filter(s => s.trim()) : [],
    music: formData.get('music') || '',
    notes: formData.get('notes') || '',
    phase: formData.get('phase') || undefined,
    envelope_instruction: formData.get('envelope_instruction') || undefined
  };
  
  if (index === null) {
    AppData.schedule.timeline.push(itemData);
  } else {
    AppData.schedule.timeline[index] = itemData;
  }
  
  saveToLocalStorage();
  closeScheduleEditor();
  
  if (window.Render && window.Render.schedule) {
    window.Render.schedule();
  }
}

function deleteTimelineItem(index) {
  const item = AppData.schedule.timeline[index];
  if (confirm(`Delete timeline item "${item.title}"?`)) {
    AppData.schedule.timeline.splice(index, 1);
    saveToLocalStorage();
    
    if (window.Render && window.Render.schedule) {
      window.Render.schedule();
    }
  }
}

function closeScheduleEditor() {
  const modal = document.getElementById('schedule-editor-modal');
  if (modal) modal.remove();
}

async function handleImportSchedule() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    try {
      const data = await importDataset('schedule', file);
      
      if (confirm(`Import schedule with ${data.timeline?.length || 0} timeline items?`)) {
        applyImportedData('schedule', data);
        
        if (window.Render && window.Render.schedule) {
          window.Render.schedule();
        }
        
        alert('Schedule imported successfully!');
      }
    } catch (error) {
      alert(`Import failed: ${error.message}`);
    }
  };
  
  input.click();
}

async function handleResetSchedule() {
  if (confirm('Reset schedule to repository defaults?')) {
    await resetToDefaults('schedule');
    
    if (window.Render && window.Render.schedule) {
      window.Render.schedule();
    }
    
    alert('Schedule reset to defaults!');
  }
}

// ============================================================================
// MYSTERY DATA IMPORT HANDLERS
// ============================================================================

async function handleImportStory() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    try {
      const data = await importDataset('story', file);
      
      if (confirm(`Import story "${data.title}"?`)) {
        applyImportedData('story', data);
        
        if (window.Render && window.Render.mystery) {
          window.Render.mystery();
        }
        
        alert('Story imported successfully!');
      }
    } catch (error) {
      alert(`Import failed: ${error.message}`);
    }
  };
  
  input.click();
}

async function handleImportClues() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    try {
      const data = await importDataset('clues', file);
      
      if (confirm(`Import ${data.length} clues?`)) {
        applyImportedData('clues', data);
        
        if (window.Render && window.Render.mystery) {
          window.Render.mystery();
        }
        
        alert('Clues imported successfully!');
      }
    } catch (error) {
      alert(`Import failed: ${error.message}`);
    }
  };
  
  input.click();
}

async function handleImportPackets() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    try {
      const data = await importDataset('packets', file);
      
      if (confirm(`Import ${data.length} character packets?`)) {
        applyImportedData('packets', data);
        
        if (window.Render && window.Render.mystery) {
          window.Render.mystery();
        }
        
        alert('Packets imported successfully!');
      }
    } catch (error) {
      alert(`Import failed: ${error.message}`);
    }
  };
  
  input.click();
}

async function handleResetStory() {
  if (confirm('Reset story to repository defaults?')) {
    await resetToDefaults('story');
    
    if (window.Render && window.Render.mystery) {
      window.Render.mystery();
    }
    
    alert('Story reset to defaults!');
  }
}

async function handleResetClues() {
  if (confirm('Reset clues to repository defaults?')) {
    await resetToDefaults('clues');
    
    if (window.Render && window.Render.mystery) {
      window.Render.mystery();
    }
    
    alert('Clues reset to defaults!');
  }
}

async function handleResetPackets() {
  if (confirm('Reset packets to repository defaults?')) {
    await resetToDefaults('packets');
    
    if (window.Render && window.Render.mystery) {
      window.Render.mystery();
    }
    
    alert('Packets reset to defaults!');
  }
}

// Role preference functions
function setRolePreference(guestId, characterId) {
  if (!AppData.rolePreferences[guestId]) {
    AppData.rolePreferences[guestId] = [];
  }
  const index = AppData.rolePreferences[guestId].indexOf(characterId);
  if (index > -1) {
    AppData.rolePreferences[guestId].splice(index, 1);
  } else {
    AppData.rolePreferences[guestId].push(characterId);
  }
}

// Suggest character assignments based on preferences and availability
function suggestAssignments() {
  const unassignedGuests = AppData.guests.filter(g => !g.assignedCharacter);
  const assignedCharacters = new Set(AppData.guests.filter(g => g.assignedCharacter).map(g => g.assignedCharacter));
  const availableCharacters = AppData.characters.filter(c => !assignedCharacters.has(c.id));
  
  // Helper function to score character match based on roleVibe
  const scoreMatch = (guest, character) => {
    if (!guest.roleVibe) return 0;
    
    const guestVibe = guest.roleVibe.toLowerCase();
    const charPersonality = (character.personality || '').toLowerCase();
    const charBriefing = (character.briefing || '').toLowerCase();
    const charRole = (character.role || '').toLowerCase();
    
    let score = 0;
    
    // Check for keyword matches in personality, briefing, and role
    const vibeWords = guestVibe.split(/\s+/);
    vibeWords.forEach(word => {
      if (charPersonality.includes(word)) score += 3;
      if (charBriefing.includes(word)) score += 2;
      if (charRole.includes(word)) score += 2;
    });
    
    return score;
  };
  
  unassignedGuests.forEach(guest => {
    // Try to match with preferred roles first
    const preferences = AppData.rolePreferences[guest.id] || [];
    const preferredAvailable = preferences.find(charId => 
      !assignedCharacters.has(charId) && availableCharacters.some(c => c.id === charId)
    );
    
    if (preferredAvailable) {
      guest.assignedCharacter = preferredAvailable;
      assignedCharacters.add(preferredAvailable);
      availableCharacters.splice(availableCharacters.findIndex(c => c.id === preferredAvailable), 1);
    } else if (availableCharacters.length > 0) {
      // Use roleVibe to rank available characters
      const scoredCharacters = availableCharacters.map(char => ({
        character: char,
        score: scoreMatch(guest, char)
      }));
      
      // Sort by score (highest first), avoiding duplicates
      scoredCharacters.sort((a, b) => b.score - a.score);
      
      // Assign best match
      const bestMatch = scoredCharacters[0].character;
      guest.assignedCharacter = bestMatch.id;
      assignedCharacters.add(bestMatch.id);
      availableCharacters.splice(availableCharacters.findIndex(c => c.id === bestMatch.id), 1);
    }
  });
  
  return unassignedGuests.length - assignedCharacters.size;
}

// Export functions
function downloadJSON(data, filename) {
  const json = JSON.stringify(data, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

function exportDecorJSON() {
  const decorWithState = {
    ...AppData.decor,
    favorites: Array.from(AppData.decorFavorites),
    customShoppingList: Array.from(AppData.decorShoppingList)
  };
  downloadJSON(decorWithState, 'decor.json');
  alert('Decor data exported! Check your downloads folder.');
}

function exportMenuJSON() {
  const menuWithState = {
    ...AppData.menu,
    favorites: Array.from(AppData.menuFavorites),
    featured: Array.from(AppData.menuFeatured)
  };
  downloadJSON(menuWithState, 'menu.json');
  alert('Menu data exported! Check your downloads folder.');
}

function exportGuestsJSON() {
  downloadJSON(AppData.guests, 'guests.json');
  alert('Guests data exported! Check your downloads folder.');
}

function exportCharactersJSON() {
  const charactersWithPrefs = {
    characters: AppData.characters,
    rolePreferences: AppData.rolePreferences
  };
  downloadJSON(charactersWithPrefs, 'characters.json');
  alert('Characters data exported! Check your downloads folder.');
}

// Export all data as ZIP using JSZip (loaded via CDN)
async function downloadAllDataAsZip() {
  if (typeof JSZip === 'undefined') {
    alert('ZIP library not loaded. Please try again.');
    return;
  }
  
  const zip = new JSZip();
  const dataFolder = zip.folder('data');
  
  // Add all JSON files with current state
  dataFolder.file('guests.json', JSON.stringify(AppData.guests, null, 2));
  dataFolder.file('characters.json', JSON.stringify({
    characters: AppData.characters,
    rolePreferences: AppData.rolePreferences
  }, null, 2));
  dataFolder.file('decor.json', JSON.stringify({
    ...AppData.decor,
    favorites: Array.from(AppData.decorFavorites),
    customShoppingList: Array.from(AppData.decorShoppingList)
  }, null, 2));
  dataFolder.file('menu.json', JSON.stringify({
    ...AppData.menu,
    favorites: Array.from(AppData.menuFavorites),
    featured: Array.from(AppData.menuFeatured)
  }, null, 2));
  dataFolder.file('schedule.json', JSON.stringify(AppData.schedule, null, 2));
  dataFolder.file('story.json', JSON.stringify(AppData.story, null, 2));
  dataFolder.file('clues.json', JSON.stringify(AppData.clues, null, 2));
  dataFolder.file('packets.json', JSON.stringify(AppData.packets, null, 2));
  
  // Generate and download
  const blob = await zip.generateAsync({ type: 'blob' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = 'bridal-party-plan-' + new Date().toISOString().split('T')[0] + '.zip';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
  alert('Complete plan exported as ZIP! Check your downloads folder.');
}

// Mystery phase management functions
function advancePhase() {
  const phases = ['intro', 'mid', 'pre-final', 'final'];
  const currentIndex = phases.indexOf(AppData.currentPhase);
  if (currentIndex < phases.length - 1) {
    AppData.currentPhase = phases[currentIndex + 1];
    return true;
  }
  return false;
}

function setPhase(phase) {
  const validPhases = ['intro', 'mid', 'pre-final', 'final'];
  if (validPhases.includes(phase)) {
    AppData.currentPhase = phase;
    return true;
  }
  return false;
}

function getCluesByPhase(phase) {
  return AppData.clues.filter(clue => clue.reveal_phase === phase);
}

function getPacketForCharacter(characterId) {
  return AppData.packets.find(p => p.character_id === characterId);
}

// Generate printable character packet HTML
function generatePrintablePacket(characterId) {
  const packet = getPacketForCharacter(characterId);
  if (!packet) return null;
  
  const character = AppData.characters.find(c => c.id === characterId);
  if (!character) return null;
  
  const html = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>${packet.intro_profile.name} - Character Packet</title>
    <style>
        @page { margin: 1in; }
        body { font-family: 'Georgia', serif; line-height: 1.6; color: #333; }
        .header { text-align: center; border-bottom: 3px solid #8B0000; padding-bottom: 20px; margin-bottom: 30px; }
        .header h1 { color: #8B0000; margin: 0; font-size: 2.5em; }
        .header h2 { color: #C79810; margin: 5px 0; font-style: italic; }
        .profile { background: #f9f9f9; border: 2px solid #0B4F3F; padding: 20px; margin: 20px 0; page-break-inside: avoid; }
        .profile h3 { color: #0B4F3F; margin-top: 0; }
        .envelope { border: 3px solid #8B0000; padding: 20px; margin: 30px 0; page-break-inside: avoid; }
        .envelope h3 { color: #8B0000; margin-top: 0; border-bottom: 1px solid #C79810; padding-bottom: 10px; }
        .phase-badge { background: #C79810; color: white; padding: 5px 15px; border-radius: 5px; display: inline-block; font-weight: bold; }
        ul { margin: 10px 0; padding-left: 20px; }
        .instructions { background: #fff9e6; border-left: 4px solid #C79810; padding: 15px; margin: 15px 0; font-style: italic; }
        @media print {
            .envelope { page-break-before: always; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸŒ² A Damn Fine Bridal Party ðŸŒ²</h1>
        <h2>Character Packet</h2>
        <p style="font-style: italic;">"The owls are not what they seem..."</p>
    </div>
    
    <div class="profile">
        <h3>${packet.intro_profile.name}</h3>
        <p><strong>Role:</strong> ${packet.intro_profile.role}</p>
        <p><em>${packet.intro_profile.tagline}</em></p>
        <p>${packet.intro_profile.overview}</p>
        
        <h4>Costume Essentials:</h4>
        <ul>
            ${packet.intro_profile.costume_essentials.map(item => `<li>${item}</li>`).join('')}
        </ul>
        
        <p><strong>Personality Notes:</strong> ${packet.intro_profile.personality_notes}</p>
        <p><strong>Secret Preview:</strong> ${packet.intro_profile.secret_preview}</p>
    </div>
    
    ${packet.envelopes.map((env, index) => `
        <div class="envelope">
            <h3>
                <span class="phase-badge">${env.phase.toUpperCase()}</span>
                ${env.title}
            </h3>
            <p>${env.contents}</p>
            <div class="instructions">
                <strong>ðŸ“‹ Instructions:</strong> ${env.instructions}
            </div>
        </div>
    `).join('')}
    
    <div style="text-align: center; margin-top: 50px; padding-top: 20px; border-top: 2px solid #8B0000;">
        <p style="font-style: italic; color: #666;">
            "Every day, once a day, give yourself a present." - Agent Cooper
        </p>
    </div>
</body>
</html>
  `;
  
  return html;
}

// Print character packet
function printCharacterPacket(characterId) {
  const html = generatePrintablePacket(characterId);
  if (!html) {
    alert('Character packet not found!');
    return;
  }
  
  const printWindow = window.open('', '', 'width=800,height=600');
  printWindow.document.write(html);
  printWindow.document.close();
  printWindow.focus();
  printWindow.print();
}

// Generate clue kit ZIP
async function downloadClueKitZip() {
  if (typeof JSZip === 'undefined') {
    alert('ZIP library not loaded. Please try again.');
    return;
  }
  
  const zip = new JSZip();
  const envelopesFolder = zip.folder('envelopes');
  
  // Generate envelope files for each character
  AppData.packets.forEach(packet => {
    const character = AppData.characters.find(c => c.id === packet.character_id);
    if (!character) return;
    
    packet.envelopes.forEach((env, index) => {
      const filename = `envelope-${packet.character_id}-${index + 1}-${env.phase}.txt`;
      const content = `
=== ${env.title} ===
Phase: ${env.phase.toUpperCase()}
Character: ${packet.intro_profile.name}

${env.contents}

--- Instructions ---
${env.instructions}
`;
      envelopesFolder.file(filename, content);
    });
  });
  
  // Add clues reference file
  const cluesContent = AppData.clues.map(clue => 
    `[${clue.id}] Phase: ${clue.reveal_phase} | Type: ${clue.type}
Holder: ${clue.holder_id}
${clue.text}
Trade Hint: ${clue.trade_hint}
---`
  ).join('\n\n');
  
  zip.file('clues-reference.txt', cluesContent);
  
  // Add director's guide
  const directorsGuide = `
=== DIRECTOR'S GUIDE ===
Mystery Phase Management for "A Damn Fine Bridal Party"

PHASES:
1. INTRO - Character introductions and initial clues
2. MID - Investigation deepens, more clues revealed
3. PRE-FINAL - Critical evidence emerges
4. FINAL - Truth revealed before solution

TIMING (from schedule.json):
- 0:50-1:00 - Character Introduction (INTRO phase, Envelope 1)
- 1:00-1:10 - Initial Investigation (INTRO continues)
- 1:10-1:25 - Mid Investigation (MID phase, Envelope 2)
- 1:25-1:35 - Final Investigation (PRE-FINAL phase, Envelope 3)
- 1:35-1:45 - Cupcake Reveal (FINAL phase, Envelope 4)

ENVELOPE DISTRIBUTION:
Print and seal all envelopes before the party. Label each envelope clearly with:
- Character name
- Envelope number (1-4)
- Phase (INTRO/MID/PRE-FINAL/FINAL)
- "DO NOT OPEN UNTIL INSTRUCTED"

PREPARATION CHECKLIST:
â˜ Print all character packets
â˜ Print and cut individual envelope contents
â˜ Seal envelopes and label clearly
â˜ Prepare clue reference sheet (this file)
â˜ Review timing and phase transitions
â˜ Test kitchen torch for cupcake reveal

TROUBLESHOOTING:
- If guests are stuck, drop hints from clues they haven't discovered yet
- If moving too fast, extend investigation phases
- If moving too slow, prompt envelope openings
- Keep the murderer (Josie Packard/owner) engaged but not obvious

Good luck, Director! ðŸŒ²
  `;
  
  zip.file('DIRECTORS-GUIDE.txt', directorsGuide);
  
  // Generate and download
  const blob = await zip.generateAsync({ type: 'blob' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = 'mystery-clue-kit.zip';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
  alert('Clue Kit ZIP downloaded! Contains all envelopes and director\'s guide.');
}

// Generate character profile for invite
function generateCharacterProfile(characterId) {
  const packet = getPacketForCharacter(characterId);
  if (!packet) return '';
  
  return `
ðŸ“œ YOUR CHARACTER: ${packet.intro_profile.name}
Role: ${packet.intro_profile.role}
${packet.intro_profile.tagline}

${packet.intro_profile.overview}

Costume: ${packet.intro_profile.costume_essentials.join(', ')}

Get ready to solve a mystery! ðŸ”
  `.trim();
}

// Calculate decision progress
function calculateDecisionProgress() {
  const totalMoodBoards = AppData.decor.moodBoard ? AppData.decor.moodBoard.length : 0;
  const totalMenuItems = AppData.menu.menuItems ? AppData.menu.menuItems.length : 0;
  const totalGuests = AppData.guests.length;
  const assignedGuests = AppData.guests.filter(g => g.assignedCharacter).length;
  
  // Calculate envelope readiness (% of guests with assigned roles who have packets)
  const guestsWithPackets = AppData.guests.filter(g => {
    if (!g.assignedCharacter) return false;
    const packet = AppData.packets.find(p => p.character_id === g.assignedCharacter);
    return packet && packet.envelopes && packet.envelopes.length === 4;
  }).length;
  
  const envelopeReadiness = assignedGuests > 0 ? 
    Math.round((guestsWithPackets / assignedGuests) * 100) : 0;
  
  return {
    decorFavorited: totalMoodBoards > 0 ? Math.round((AppData.decorFavorites.size / totalMoodBoards) * 100) : 0,
    menuFeatured: totalMenuItems > 0 ? Math.round((AppData.menuFeatured.size / totalMenuItems) * 100) : 0,
    rolesAssigned: totalGuests > 0 ? Math.round((assignedGuests / totalGuests) * 100) : 0,
    totalFavorites: AppData.decorFavorites.size + AppData.menuFavorites.size,
    totalFeatured: AppData.menuFeatured.size,
    totalAssigned: assignedGuests,
    envelopeReadiness: envelopeReadiness,
    guestsWithPackets: guestsWithPackets
  };
}

// ============================================================================
// PERSISTENCE & AUTOSAVE FUNCTIONS
// ============================================================================

// Toggle autosave
function toggleAutosave() {
  // With Firebase, autosave is always enabled for syncing
  // This function now controls Firebase sync
  AppData.autosaveEnabled = !AppData.autosaveEnabled;
  localStorage.setItem('autosaveEnabled', AppData.autosaveEnabled.toString());
  
  if (AppData.autosaveEnabled && FIREBASE_ENABLED && FirebaseManager) {
    saveToFirestore();
  }
  
  return AppData.autosaveEnabled;
}

// Save current state to Firestore (replaces localStorage)
async function saveToFirestore() {
  if (!FIREBASE_ENABLED || !FirebaseManager) {
    // Fallback to localStorage if Firebase is disabled
    saveToLocalStorage();
    return;
  }
  
  try {
    await Promise.all([
      FirebaseManager.saveData('guests', AppData.guests),
      FirebaseManager.saveData('characters', AppData.characters),
      FirebaseManager.saveData('decor', AppData.decor),
      FirebaseManager.saveData('vendors', AppData.vendors),
      FirebaseManager.saveData('menu', AppData.menu),
      FirebaseManager.saveData('schedule', AppData.schedule),
      FirebaseManager.saveData('story', AppData.story),
      FirebaseManager.saveData('clues', AppData.clues),
      FirebaseManager.saveData('packets', AppData.packets)
    ]);
    console.log('Data saved to Firestore');
  } catch (error) {
    console.error('Error saving to Firestore:', error);
  }
}

// Save current state to localStorage (fallback)
function saveToLocalStorage() {
  if (!AppData.autosaveEnabled) return;
  
  const dataToSave = {
    guests: AppData.guests,
    characters: AppData.characters,
    decor: AppData.decor,
    vendors: AppData.vendors,
    menu: AppData.menu,
    schedule: AppData.schedule,
    story: AppData.story,
    clues: AppData.clues,
    packets: AppData.packets
  };
  
  localStorage.setItem('appData', JSON.stringify(dataToSave));
}

// Reset to defaults from repo
async function resetToDefaults(datasetName) {
  if (!datasetName || datasetName === 'all') {
    // Reset all datasets
    AppData.guests = JSON.parse(JSON.stringify(AppData.defaults.guests));
    AppData.characters = JSON.parse(JSON.stringify(AppData.defaults.characters));
    AppData.decor = JSON.parse(JSON.stringify(AppData.defaults.decor));
    AppData.vendors = JSON.parse(JSON.stringify(AppData.defaults.vendors));
    AppData.menu = JSON.parse(JSON.stringify(AppData.defaults.menu));
    AppData.schedule = JSON.parse(JSON.stringify(AppData.defaults.schedule));
    AppData.story = JSON.parse(JSON.stringify(AppData.defaults.story));
    AppData.clues = JSON.parse(JSON.stringify(AppData.defaults.clues));
    AppData.packets = JSON.parse(JSON.stringify(AppData.defaults.packets));
  } else {
    // Reset specific dataset
    if (AppData.defaults[datasetName]) {
      AppData[datasetName] = JSON.parse(JSON.stringify(AppData.defaults[datasetName]));
    }
  }
  
  saveToLocalStorage();
}

// ============================================================================
// GENERIC CRUD HELPERS
// ============================================================================

// Add item to array dataset
function addItem(datasetName, item) {
  if (Array.isArray(AppData[datasetName])) {
    AppData[datasetName].push(item);
  } else if (AppData[datasetName] && Array.isArray(AppData[datasetName][datasetName])) {
    // For nested arrays like menu.menuItems
    AppData[datasetName][datasetName].push(item);
  }
  saveToLocalStorage();
}

// Update item in array dataset
function updateItem(datasetName, id, updates) {
  let dataset = AppData[datasetName];
  
  // Handle nested structures
  if (!Array.isArray(dataset)) {
    // Try common nested patterns
    if (dataset && Array.isArray(dataset.menuItems)) {
      dataset = dataset.menuItems;
    } else if (dataset && Array.isArray(dataset.timeline)) {
      dataset = dataset.timeline;
    } else if (dataset && Array.isArray(dataset.moodBoard)) {
      dataset = dataset.moodBoard;
    } else if (dataset && Array.isArray(dataset.shoppingList)) {
      dataset = dataset.shoppingList;
    }
  }
  
  if (Array.isArray(dataset)) {
    const index = dataset.findIndex(item => item.id === id);
    if (index !== -1) {
      dataset[index] = { ...dataset[index], ...updates };
    }
  }
  
  saveToLocalStorage();
}

// Delete item from array dataset
function deleteItem(datasetName, id) {
  let dataset = AppData[datasetName];
  
  // Handle nested structures
  if (!Array.isArray(dataset)) {
    if (dataset && Array.isArray(dataset.menuItems)) {
      dataset.menuItems = dataset.menuItems.filter(item => item.id !== id);
    } else if (dataset && Array.isArray(dataset.timeline)) {
      dataset.timeline = dataset.timeline.filter(item => item.id !== id);
    } else if (dataset && Array.isArray(dataset.moodBoard)) {
      dataset.moodBoard = dataset.moodBoard.filter(item => item.id !== id);
    } else if (dataset && Array.isArray(dataset.shoppingList)) {
      dataset.shoppingList = dataset.shoppingList.filter(item => item.id !== id);
    }
  } else {
    AppData[datasetName] = dataset.filter(item => item.id !== id);
  }
  
  saveToLocalStorage();
}

// ============================================================================
// IMPORT/EXPORT UTILITIES
// ============================================================================

// Generic export function
function exportDataset(datasetName, data) {
  const jsonStr = JSON.stringify(data, null, 2);
  const blob = new Blob([jsonStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${datasetName}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

// Generic import function with validation
async function importDataset(datasetName, file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    
    reader.onload = (e) => {
      try {
        const data = JSON.parse(e.target.result);
        
        // Basic validation
        if (data === null || data === undefined) {
          reject(new Error('Invalid JSON: file is empty'));
          return;
        }
        
        // Schema validation based on dataset
        const isValid = validateImportSchema(datasetName, data);
        if (!isValid) {
          reject(new Error(`Invalid schema for ${datasetName}`));
          return;
        }
        
        resolve(data);
      } catch (error) {
        reject(new Error(`Failed to parse JSON: ${error.message}`));
      }
    };
    
    reader.onerror = () => reject(new Error('Failed to read file'));
    reader.readAsText(file);
  });
}

// Validate import schema
function validateImportSchema(datasetName, data) {
  switch (datasetName) {
    case 'guests':
      return Array.isArray(data) && data.every(item => 
        item != null && 'id' in item && 'name' in item
      );
    
    case 'characters':
      return Array.isArray(data) && data.every(item => 
        item != null && 'id' in item && 'name' in item && 'role' in item
      );
    
    case 'vendors':
      return Array.isArray(data) && data.every(item => 
        item != null && 'name' in item && 'type' in item
      );
    
    case 'menu':
      return data != null && 'menuItems' in data && Array.isArray(data.menuItems);
    
    case 'decor':
      return data != null && 'moodBoard' in data && 'shoppingList' in data;
    
    case 'schedule':
      return data != null && 'timeline' in data && Array.isArray(data.timeline);
    
    case 'story':
      return data != null && 'title' in data && 'theMurder' in data && 
             'theMurderer' in data;
    
    case 'clues':
      return Array.isArray(data) && data.every(item => 
        item != null && 'id' in item && 'type' in item && 'text' in item
      );
    
    case 'packets':
      return Array.isArray(data) && data.every(item => 
        item != null && 'character_id' in item && 'intro_profile' in item && 
        'envelopes' in item
      );
    
    default:
      return true; // Allow unknown datasets
  }
}

// Apply imported data
function applyImportedData(datasetName, data) {
  AppData[datasetName] = data;
  saveToLocalStorage();
}

// Export specific datasets
function exportGuests() {
  exportDataset('guests', AppData.guests);
}

function exportCharacters() {
  exportDataset('characters', AppData.characters);
}

function exportVendors() {
  exportDataset('vendors', AppData.vendors);
}

function exportDecor() {
  exportDataset('decor', AppData.decor);
}

function exportMenu() {
  exportDataset('menu', AppData.menu);
}

function exportSchedule() {
  exportDataset('schedule', AppData.schedule);
}

function exportStory() {
  exportDataset('story', AppData.story);
}

function exportClues() {
  exportDataset('clues', AppData.clues);
}

function exportPackets() {
  exportDataset('packets', AppData.packets);
}

// Export functions for use in other modules
if (typeof module !== 'undefined' && module.exports) {
  module.exports = {
    AppData,
    loadData,
    initApp,
    calculateStats,
    autoAssignCharacters,
    generateCharacterPacket,
    generateInviteText,
    validateData,
    formatDate,
    toggleDecorFavorite,
    toggleDecorShoppingList,
    toggleMenuFavorite,
    toggleMenuFeatured,
    setRolePreference,
    suggestAssignments,
    downloadJSON,
    exportDecorJSON,
    exportMenuJSON,
    exportGuestsJSON,
    exportCharactersJSON,
    downloadAllDataAsZip,
    calculateDecisionProgress,
    // New persistence functions
    toggleAutosave,
    saveToLocalStorage,
    resetToDefaults,
    // New CRUD helpers
    addItem,
    updateItem,
    deleteItem,
    // New import/export functions
    exportDataset,
    importDataset,
    validateImportSchema,
    applyImportedData,
    exportGuests,
    exportCharacters,
    exportVendors,
    exportDecor,
    exportMenu,
    exportSchedule,
    exportStory,
    exportClues,
    exportPackets,
    // Guest CRUD functions
    showAddGuestForm,
    editGuest,
    handleSaveGuest,
    deleteGuest,
    closeGuestEditor,
    handleAutosaveToggle,
    handleImportGuests,
    handleResetGuests,
    // Menu CRUD functions
    showAddMenuItemForm,
    editMenuItem,
    handleSaveMenuItem,
    deleteMenuItem,
    closeMenuEditor,
    handleImportMenu,
    handleResetMenu,
    // Decor CRUD functions
    showAddMoodBoardForm,
    editMoodBoard,
    handleSaveMoodBoard,
    deleteMoodBoard,
    showAddShoppingCategoryForm,
    handleSaveShoppingCategory,
    deleteShoppingCategory,
    showAddShoppingItemForm,
    editShoppingItem,
    handleSaveShoppingItem,
    deleteShoppingItem,
    togglePurchased,
    closeDecorEditor,
    handleImportDecor,
    handleResetDecor,
    // Schedule CRUD functions
    showAddTimelineForm,
    editTimelineItem,
    handleSaveTimelineItem,
    deleteTimelineItem,
    closeScheduleEditor,
    handleImportSchedule,
    handleResetSchedule,
    // Mystery data import/reset handlers
    handleImportStory,
    handleImportClues,
    handleImportPackets,
    handleResetStory,
    handleResetClues,
    handleResetPackets,
    // Admin Data Manager functions
    handleExportDataset,
    handleImportDataset,
    handleResetDataset
  };
}
