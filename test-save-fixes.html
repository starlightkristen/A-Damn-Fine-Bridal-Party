<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Save Fixes - A Damn Fine Bridal Party</title>
    <link rel="stylesheet" href="./assets/styles.css">
    <style>
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .pass {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .fail {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸ§ª Save Fixes Test Page</h1>
            <p>Validate that edits save properly and don't get lost</p>
        </header>

        <nav>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="guests.html">Residents</a></li>
            </ul>
        </nav>

        <div class="card">
            <h2>Test Results</h2>
            <div id="test-results"></div>
        </div>

        <div class="card">
            <h2>Manual Tests</h2>
            <div class="test-section">
                <h3>Test 1: beforeunload Handler</h3>
                <p>This test simulates a save operation and tries to navigate away.</p>
                <button onclick="testBeforeUnload()" class="btn">Test beforeunload</button>
                <div id="test1-result"></div>
            </div>

            <div class="test-section">
                <h3>Test 2: Firebase Initialization</h3>
                <p>Check if Firebase is initialized before allowing edits.</p>
                <button onclick="testFirebaseInit()" class="btn">Test Firebase Init</button>
                <div id="test2-result"></div>
            </div>

            <div class="test-section">
                <h3>Test 3: Load Priority</h3>
                <p>Check if data loads from Firebase first, then falls back to JSON.</p>
                <button onclick="testLoadPriority()" class="btn">Test Load Priority</button>
                <div id="test3-result"></div>
            </div>

            <div class="test-section">
                <h3>Test 4: Save with Retry</h3>
                <p>Test the retry mechanism for failed saves.</p>
                <button onclick="testSaveRetry()" class="btn">Test Save Retry</button>
                <div id="test4-result"></div>
            </div>
        </div>
    </div>

    <script src="./assets/app.js"></script>
    <script>
        // Test 1: beforeunload Handler
        function testBeforeUnload() {
            const result = document.getElementById('test1-result');
            result.innerHTML = '<div class="test-result info">Testing beforeunload handler...</div>';
            
            // Simulate saving state
            SaveStatus.currentState = 'saving';
            
            // Check if beforeunload is registered
            const hasHandler = window.onbeforeunload !== null || 
                               document.querySelectorAll('[onbeforeunload]').length > 0;
            
            // Try to trigger it
            const event = new Event('beforeunload', { cancelable: true });
            window.dispatchEvent(event);
            
            // Reset state
            SaveStatus.currentState = 'idle';
            
            if (hasHandler || event.defaultPrevented) {
                result.innerHTML = '<div class="test-result pass">âœ“ PASS: beforeunload handler is registered and working</div>';
            } else {
                result.innerHTML = '<div class="test-result fail">âœ— FAIL: beforeunload handler not working</div>';
            }
        }

        // Test 2: Firebase Initialization
        function testFirebaseInit() {
            const result = document.getElementById('test2-result');
            result.innerHTML = '<div class="test-result info">Checking Firebase initialization...</div>';
            
            setTimeout(() => {
                if (typeof FirebaseManager !== 'undefined' && FirebaseManager !== null) {
                    result.innerHTML = '<div class="test-result pass">âœ“ PASS: FirebaseManager is initialized</div>';
                } else if (!FIREBASE_ENABLED) {
                    result.innerHTML = '<div class="test-result info">â„¹ INFO: Firebase is disabled in this environment</div>';
                } else {
                    result.innerHTML = '<div class="test-result fail">âœ— FAIL: FirebaseManager not initialized</div>';
                }
            }, 1000);
        }

        // Test 3: Load Priority
        function testLoadPriority() {
            const result = document.getElementById('test3-result');
            result.innerHTML = '<div class="test-result info">Checking load priority...</div>';
            
            // Check if loadFromFirestore function exists
            const hasLoadFromFirestore = typeof loadFromFirestore === 'function';
            
            if (hasLoadFromFirestore) {
                result.innerHTML = '<div class="test-result pass">âœ“ PASS: loadFromFirestore() helper function exists</div>';
            } else {
                result.innerHTML = '<div class="test-result fail">âœ— FAIL: loadFromFirestore() function not found</div>';
            }
        }

        // Test 4: Save with Retry
        function testSaveRetry() {
            const result = document.getElementById('test4-result');
            result.innerHTML = '<div class="test-result info">Testing save retry mechanism...</div>';
            
            // Check if saveWithRetry function exists
            const hasSaveWithRetry = typeof saveWithRetry === 'function';
            
            if (hasSaveWithRetry) {
                result.innerHTML = '<div class="test-result pass">âœ“ PASS: saveWithRetry() function exists</div>';
            } else {
                result.innerHTML = '<div class="test-result fail">âœ— FAIL: saveWithRetry() function not found</div>';
            }
        }

        // Auto-run tests on page load
        document.addEventListener('DOMContentLoaded', async function() {
            await initApp();
            
            const testResults = document.getElementById('test-results');
            testResults.innerHTML = '<div class="test-result info">Running automated tests...</div>';
            
            let allPassed = true;
            let results = [];
            
            // Test 1: Check for new helper functions
            if (typeof loadFromFirestore === 'function') {
                results.push('<div class="test-result pass">âœ“ loadFromFirestore() function exists</div>');
            } else {
                results.push('<div class="test-result fail">âœ— loadFromFirestore() function missing</div>');
                allPassed = false;
            }
            
            if (typeof saveWithRetry === 'function') {
                results.push('<div class="test-result pass">âœ“ saveWithRetry() function exists</div>');
            } else {
                results.push('<div class="test-result fail">âœ— saveWithRetry() function missing</div>');
                allPassed = false;
            }
            
            // Test 2: Check for visual overlay functions
            if (typeof showSavingOverlay === 'function') {
                results.push('<div class="test-result pass">âœ“ showSavingOverlay() function exists</div>');
            } else {
                results.push('<div class="test-result fail">âœ— showSavingOverlay() function missing</div>');
                allPassed = false;
            }
            
            if (typeof hideSavingOverlay === 'function') {
                results.push('<div class="test-result pass">âœ“ hideSavingOverlay() function exists</div>');
            } else {
                results.push('<div class="test-result fail">âœ— hideSavingOverlay() function missing</div>');
                allPassed = false;
            }
            
            // Test 3: Check SaveStatus object
            if (typeof SaveStatus !== 'undefined' && SaveStatus.currentState !== undefined) {
                results.push('<div class="test-result pass">âœ“ SaveStatus object exists with currentState</div>');
            } else {
                results.push('<div class="test-result fail">âœ— SaveStatus object missing or incomplete</div>');
                allPassed = false;
            }
            
            // Display results
            testResults.innerHTML = results.join('') + 
                (allPassed ? 
                    '<div class="test-result pass" style="margin-top: 20px; font-weight: bold;">âœ“ ALL AUTOMATED TESTS PASSED</div>' : 
                    '<div class="test-result fail" style="margin-top: 20px; font-weight: bold;">âœ— SOME TESTS FAILED</div>');
        });
    </script>
</body>
</html>
